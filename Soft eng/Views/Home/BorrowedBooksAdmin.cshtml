@{
    ViewBag.Title = "BorrowedBooks";
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Management System - Borrowed Books</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="~/css/borrowedbooks.css">
    <link rel="stylesheet" href="~/css/filter-dropdown.css">
    <link rel="stylesheet" href="~/css/report-modal.css">
    <link rel="stylesheet" href="~/css/chatbot.css">
</head>
<body>

    <header class="top-header">
        <div class="logo-area">
            <div class="logo-circle">
                <img src="~/images/school_logo.jpg" alt="SIA Logo">
            </div>
            <span class="school-name">SAINT ISIDORE ACADEMY</span>
        </div>

        <div class="user-area">
            <form asp-action="Logout" asp-controller="Home" method="post" id="logoutForm" style="display:inline;">
                <a href="javascript:void(0);" onclick="document.getElementById('logoutForm').submit();" class="logout-link">
                    <span class="logout-text">Log Out</span>
                </a>
            </form>
            <div class="user-avatar admin-avatar">
                <img src="https://cdn-icons-png.flaticon.com/512/1946/1946429.png" alt="Admin Avatar">
            </div>
        </div>
    </header>

    <div class="main-layout">
        <aside class="sidebar admin">
            <nav>
                <ul>
                    <li><a asp-action="AdminDashboard">Dashboard</a></li>
                    <li><a asp-action="InventoryAdmin">Inventory</a></li>
                    <li><a asp-action="AddBooksAdmin">Add Books</a></li>
                    <li class="active"><a asp-action="BorrowedBooksAdmin">Borrowed Books</a></li>
                    <li><a asp-action="RequestedBooksAdmin">Requested Books</a></li>
                    <li><a asp-action="FineAdmin">Fine</a></li>
                    <li><a href="#">AI Chatbot</a></li>
                </ul>
            </nav>
        </aside>

        <main class="content-area">
            <h2>Borrowed Books</h2>

            <div class="search-filter">
                <input type="text" placeholder="Search by Title, Borrower, etc.">
                <div class="filter-dropdown">
                    <button type="button" class="btn-filter filter-btn">Filter</button>
                    <div class="filter-options">
                        <div class="filter-option">Available</div>
                        <div class="filter-option">Borrowed</div>
                        <div class="filter-option">Damaged</div>
                        <div class="filter-option">Missing/Lost</div>
                        <div class="filter-option">Author</div>
                        <div class="filter-option">Title</div>
                        <div class="filter-option">Publisher</div>
                        <div class="filter-option">Donation</div>
                        <div class="filter-option">Year</div>
                        <div class="filter-option">Category</div>
                        <div class="filter-option">Shelf Location</div>
                    </div>
                </div>
            </div>

            <div class="table-card">
                <table id="borrowedBooksTable">
                    <thead>
                        <tr>
                            <th>Loan ID</th>
                            <th>Borrower Name</th>
                            <th>Title</th>
                            <th>Due Date</th>
                            <th>Date Returned</th>
                            <th>Overdue Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>

            <div class="button-area">
                <button class="btn btn-blue" id="issueBookBtn">Issue Book</button>
                <button class="btn btn-green" id="generateReportBtn">Generate Report</button>             
                <button class="btn btn-red" id="editIssueBookBtn">Edit Issue Book</button>
            </div>
        </main>

    </div>

    <!-- Issue Book Modal -->
    <div id="issueBookModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <div class="modal-header">
                <h2>Borrow Book</h2>
                <p>Input the details of the borrowed book</p>
            </div>
            <form id="issueBookForm">
                <div class="form-group">
                    <label for="borrowerName">Borrower Name</label>
                    <input type="text" id="borrowerName" name="borrowerName" placeholder="Enter borrower name" required>
                </div>
                <div class="form-group">
                    <label for="bookTitle">Book Title</label>
                    <input type="text" id="bookTitle" name="bookTitle" placeholder="Enter book title" required>
                </div>
                <div class="form-group">
                    <label for="borrowDate">Borrow Date</label>
                    <input type="date" id="borrowDate" name="borrowDate" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel">Cancel</button>
                    <button type="submit" class="btn-issue">Issue</button>
                </div>
            </form>
        </div>
    </div>

    <div id="reportModal" class="report-modal">
        <div class="report-modal-content">
            <button id="closeReportModal" class="close-report-modal">&times;</button>
            <h2>Select Report Format</h2>
            <p>Choose the format for your report:</p>
            <div class="report-format-buttons">
                <button class="report-format-btn pdf" data-format="pdf">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button class="report-format-btn csv" data-format="csv">
                    <i class="fas fa-file-csv"></i> CSV
                </button>
            </div>
        </div>
    </div>

    <script src="~/js/dashboard.js"></script>
    <script src="~/js/reportGeneration.js"></script>
    <script src="~/js/chatbot.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Modal Elements
            const issueBookBtn = document.getElementById('issueBookBtn');
            const issueBookModal = document.getElementById('issueBookModal');
            const closeModalBtn = issueBookModal.querySelector('.close-modal');
            const cancelBtn = issueBookModal.querySelector('.btn-cancel');
            const issueBookForm = document.getElementById('issueBookForm');
            const borrowedBooksTable = document.getElementById('borrowedBooksTable').getElementsByTagName('tbody')[0];
            const borrowDateInput = document.getElementById('borrowDate');
            
            // Load borrowed books from database
            loadBorrowedBooks();

            // Function to format date as mm/dd/yyyy
            function formatDate(date) {
                if (!date) return '-';
                const d = new Date(date);
                const month = (d.getMonth() + 1).toString().padStart(2, '0');
                const day = d.getDate().toString().padStart(2, '0');
                const year = d.getFullYear();
                return `${month}/${day}/${year}`;
            }

            // Function to format date as yyyy-mm-dd (for date input)
            function formatDateForInput(date) {
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const year = date.getFullYear();
                return `${year}-${month}-${day}`;
            }

            // Load borrowed books from server
            async function loadBorrowedBooks() {
                try {
                    const response = await fetch('@Url.Action("GetBorrowedBooks", "Home")');
                    if (!response.ok) {
                        throw new Error('Failed to load borrowed books. Status: ' + response.status);
                    }
                    const books = await response.json();
                    
                    borrowedBooksTable.innerHTML = '';
                    
                    if (books && books.length > 0) {
                        books.forEach(book => {
                            const newRow = borrowedBooksTable.insertRow();
                            newRow.dataset.loanId = book.loanID;
                            
                            newRow.innerHTML = `
                                <td>${book.loanID}</td>
                                <td>${book.borrowerName}</td>
                                <td>${book.bookTitle}</td>
                                <td>${book.dueDate}</td>
                                <td>${book.dateReturned}</td>
                                <td>
                                    <button class="overdue-btn ${book.overdueStatus === 'Yes' ? 'overdue-yes' : 'overdue-no'}" 
                                            onclick="toggleOverdueStatus(${book.loanID}, this)">
                                        ${book.overdueStatus}
                                    </button>
                                </td>
                            `;
                        });
                    } else {
                        // Show empty table message
                        const emptyRow = borrowedBooksTable.insertRow();
                        emptyRow.innerHTML = `
                            <td colspan="6" style="text-align: center; padding: 40px; color: #999; font-style: italic;">
                                No borrowed books found. Click "Issue Book" to add one.
                            </td>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading borrowed books:', error);
                    borrowedBooksTable.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #e74c3c;">
                                Error loading borrowed books: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }

            // Open Modal
            issueBookBtn.addEventListener('click', function() {
                issueBookModal.style.display = 'flex';
                // Set today's date as default in the borrow date field
                const today = new Date();
                borrowDateInput.value = formatDateForInput(today);
                // Set min date to today (can't borrow for past dates)
                borrowDateInput.min = formatDateForInput(today);
                // Set max date to 1 year from now
                const maxDate = new Date();
                maxDate.setFullYear(maxDate.getFullYear() + 1);
                borrowDateInput.max = formatDateForInput(maxDate);
            });

            // Close Modal
            function closeModal() {
                issueBookModal.style.display = 'none';
                issueBookForm.reset();
            }

            closeModalBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);

            // Close modal when clicking outside
            issueBookModal.addEventListener('click', function(e) {
                if (e.target === issueBookModal) {
                    closeModal();
                }
            });

            // Handle form submission
            issueBookForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Get form values
                const borrowerName = document.getElementById('borrowerName').value.trim();
                const bookTitle = document.getElementById('bookTitle').value.trim();
                const borrowDateStr = document.getElementById('borrowDate').value;
                
                // Validate inputs
                if (!borrowerName) {
                    alert('Please enter borrower name');
                    return;
                }
                
                if (!bookTitle) {
                    alert('Please enter book title');
                    return;
                }
                
                if (!borrowDateStr) {
                    alert('Please select borrow date');
                    return;
                }
                
                try {
                    // Send data to server
                    const response = await fetch('@Url.Action("AddBorrowedBook", "Home")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            borrowerName: borrowerName,
                            bookTitle: bookTitle,
                            borrowDate: borrowDateStr
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to issue book. Status: ' + response.status);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Close modal and reset form
                        closeModal();
                        
                        // Reload the table
                        await loadBorrowedBooks();
                        
                        // Show success message
                        alert('Book issued successfully!\nLoan ID: ' + result.loanId + '\nDue Date: ' + result.dueDate);
                    } else {
                        alert('Error issuing book: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while issuing the book: ' + error.message);
                }
            });

            // Edit Issue Book button functionality
            const editIssueBookBtn = document.getElementById('editIssueBookBtn');
            editIssueBookBtn.addEventListener('click', function() {
                const rows = borrowedBooksTable.rows;
                if (rows.length === 0 || (rows.length === 1 && rows[0].cells[0].colSpan === 6)) {
                    alert('No books to edit. Please issue a book first.');
                    return;
                }
                
                // For now, just show an alert - you can implement editing functionality here
                alert('Edit functionality to be implemented. Select a book to edit.');
            });
        });

        // Toggle overdue status function (for global access)
        async function toggleOverdueStatus(loanId, button) {
            const newStatus = button.textContent === 'No' ? 'Yes' : 'No';
            
            try {
                const response = await fetch('@Url.Action("UpdateOverdueStatus", "Home")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        loanId: loanId,
                        status: newStatus
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update status. Status: ' + response.status);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    button.textContent = newStatus;
                    button.className = newStatus === 'Yes' ? 'overdue-btn overdue-yes' : 'overdue-btn overdue-no';
                } else {
                    alert('Error updating status');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while updating status: ' + error.message);
            }
        }
    </script>
</body>
</html>